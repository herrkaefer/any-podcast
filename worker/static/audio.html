<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio</title>
  </head>
  <body>
    <script>
      const concatAudioFilesOnBrowser = async (audioFiles, options = {}) => {
        const script = document.createElement('script')
        script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js'
        document.head.appendChild(script)
        await new Promise((resolve) => (script.onload = resolve))

        const { createFFmpeg, fetchFile } = FFmpeg
        const ffmpeg = createFFmpeg({ log: true })

        await ffmpeg.load()

        // Download and write each file to FFmpeg's virtual file system
        for (const [index, audioFile] of audioFiles.entries()) {
          const audioData = await fetchFile(audioFile)
          ffmpeg.FS('writeFile', `input${index}.mp3`, audioData)
        }

        // Create a file list for ffmpeg concat
        const fileList = audioFiles.map((_, i) => `file 'input${i}.mp3'`).join('\n')
        ffmpeg.FS('writeFile', 'filelist.txt', fileList)

        const quality = Number.isFinite(Number(options.audioQuality)) ? String(Number(options.audioQuality)) : '5'

        // Execute FFmpeg command to concatenate files
        await ffmpeg.run(
          '-f',
          'concat',
          '-safe',
          '0',
          '-i',
          'filelist.txt',
          '-c:a',
          'libmp3lame',
          '-q:a',
          quality,
          'output.mp3',
        )

        // Read the output file
        const data = ffmpeg.FS('readFile', 'output.mp3')

        // Create a downloadable link
        const blob = new Blob([data.buffer], { type: 'audio/mp3' })

        // Clean up
        audioFiles.forEach((_, i) => {
          ffmpeg.FS('unlink', `input${i}.mp3`)
        })
        ffmpeg.FS('unlink', 'filelist.txt')
        ffmpeg.FS('unlink', 'output.mp3')

        return blob
      }

      const addIntroMusicOnBrowser = async (podcastAudioUrl, themeAudioUrl, options = {}) => {
        const script = document.createElement('script')
        script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js'
        document.head.appendChild(script)
        await new Promise((resolve) => (script.onload = resolve))

        const { createFFmpeg, fetchFile } = FFmpeg
        const ffmpeg = createFFmpeg({ log: true })

        await ffmpeg.load()

        // Download and write both files to FFmpeg's virtual file system
        const themeData = await fetchFile(themeAudioUrl)
        ffmpeg.FS('writeFile', 'theme.mp3', themeData)

        const podcastData = await fetchFile(podcastAudioUrl)
        ffmpeg.FS('writeFile', 'podcast.mp3', podcastData)

        const fadeOutStart = Number.isFinite(Number(options.fadeOutStart)) ? Number(options.fadeOutStart) : 19
        const fadeOutDuration = Number.isFinite(Number(options.fadeOutDuration)) ? Number(options.fadeOutDuration) : 3
        const podcastDelayMs = Number.isFinite(Number(options.podcastDelayMs)) ? Number(options.podcastDelayMs) : 19000
        const quality = Number.isFinite(Number(options.audioQuality)) ? String(Number(options.audioQuality)) : '5'

        const filter = `[0]afade=t=out:st=${fadeOutStart}:d=${fadeOutDuration}[intro];[1]adelay=${podcastDelayMs}|${podcastDelayMs}[podcast];[intro][podcast]amix=inputs=2:duration=longest`

        // Execute FFmpeg command to mix intro music with podcast
        // theme music fades out then podcast delayed and mixed
        // amix combines both, taking the longest duration
        await ffmpeg.run(
          '-i',
          'theme.mp3',
          '-i',
          'podcast.mp3',
          '-filter_complex',
          filter,
          '-c:a',
          'libmp3lame',
          '-q:a',
          quality,
          'output.mp3',
        )

        // Read the output file
        const data = ffmpeg.FS('readFile', 'output.mp3')

        // Create a blob
        const blob = new Blob([data.buffer], { type: 'audio/mp3' })

        // Clean up
        ffmpeg.FS('unlink', 'theme.mp3')
        ffmpeg.FS('unlink', 'podcast.mp3')
        ffmpeg.FS('unlink', 'output.mp3')

        return blob
      }
    </script>
  </body>
</html>
